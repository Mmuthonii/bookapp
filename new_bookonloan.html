<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Books on Loan</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #e5e1da;
        color: #4a4a3d;
      }

      header {
        background-color: #9cab85;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        position: relative;
      }

      header .logo {
        font-size: 1.5rem; /* Slightly larger for better readability */
        font-style: italic;
        color: #4a4a3d;
        font-weight: bold;
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
      }

      nav a {
        text-decoration: none;
        color: #ffffff;
        font-size: 1.1rem;
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      nav a:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .icon-bar {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .icon {
        width: 24px; /* Adjust the size if needed */
        height: 24px;
        cursor: pointer;
        fill: white; /* Ensures the icon color matches your navbar */
        transition: opacity 0.3s ease;
      }

      .icon:hover {
        opacity: 0.7;
      }

      .icons {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .icons .icon {
        cursor: pointer;
        font-size: 1.5rem;
        color: #ffffff;
        position: relative;
      }

      .search-popup {
        display: none;
        position: absolute;
        top: 50px; /* Adjusted positioning */
        right: 20px; /* Aligns with search icon */
        background-color: #ffffff;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1000; /* Ensures it appears above other elements */
      }

      .search-popup input {
        padding: 8px;
        font-size: 1rem;
        width: 200px;
        border: 1px solid #ddd;
        border-radius: 4px;
        outline: none;
      }

      .dropdown {
        display: none;
        position: absolute;
        top: 50px;
        right: 60px;
        background-color: #ffffff;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      }

      .dropdown a {
        display: block;
        padding: 10px;
        text-decoration: none;
        color: #4a4a3d;
      }

      .dropdown a:hover {
        background-color: #f0f0f0;
      }

      /* Page Title */
      .page-title {
        text-align: center;
        margin: 2rem 0;
        font-size: 2rem;
      }

      /* Book Grid */
      .book-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 2rem;
        justify-items: center;
      }

      .book-item {
        text-align: center;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        width: 200px;
      }

      .book-placeholder img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 8px;
      }

      .book-title {
        margin-top: 1rem;
        font-size: 1rem;
        font-weight: bold;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: center;
        margin: 2rem 0;
        gap: 10px;
      }

      .pagination a {
        text-decoration: none;
        color: #4a4a3d;
        background-color: #ddd;
        padding: 8px 12px;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      .pagination a:hover {
        background-color: #9cab85;
        color: white;
      }

      .pagination .active {
        background-color: #6c9e6b;
        color: white;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">OneMoreChapter</div>
      <nav>
        <ul>
          <li><a href="home.html">Home</a></li>
          <li><a href="loan.html">Books on Loan</a></li>
          <li><a href="inventory.html">My Inventory</a></li>
          <li><a href="reading.html">Currently Reading</a></li>
          <li><a href="requests.html">Requests</a></li>
        </ul>
      </nav>
      <div class="icons">
        <!-- Search Icon -->
        <svg
          class="icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          onclick="toggleSearchPopup(event)"
        >
          <path
            d="M10 2a8 8 0 015.293 13.707l4 4a1 1 0 01-1.414 1.414l-4-4A8 8 0 1110 2zm0 2a6 6 0 100 12 6 6 0 000-12z"
          ></path>
        </svg>

        <!-- Messaging Icon -->
        <svg
          class="icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          onclick="window.location.href='new_messages.html'"
        >
          <path
            d="M20 2H4a2 2 0 00-2 2v12a2 2 0 002 2h4l4 4v-4h8a2 2 0 002-2V4a2 2 0 00-2-2zm0 12H10v2.586L8.414 14H4V4h16v10z"
          ></path>
        </svg>

        <!-- Profile Icon -->
        <svg
          class="icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          onclick="toggleDropdown()"
        >
          <path
            d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.418 0-8 2.015-8 4.5V21h16v-2.5c0-2.485-3.582-4.5-8-4.5z"
          ></path>
        </svg>

        <div class="dropdown" id="dropdownMenu">
          <a href="new_profile.html">My Profile</a>
          <a href="new_settings.html">My Profile</a>
          <a href="#" onclick="logout()">Log Out</a>
        </div>
      </div>
      <div class="search-popup" id="searchPopup">
        <input
          type="text"
          id="navSearchInput"
          placeholder="Search for books..."
          onkeydown="handleSearch(event)"
        />
        <button onclick="searchBooksFromNav()">Search</button>
      </div>
      <!-- Search Box -->
      <div class="search-popup" id="searchPopup">
        <input
          type="text"
          id="navSearchInput"
          placeholder="Search..."
          onkeydown="handleSearch(event)"
        />
      </div>
    </header>

    <main>
      <div class="page-title">
        <h2>Books on Loan</h2>
      </div>

      <section class="book-grid" id="bookContainer">
        <!-- Books will be dynamically added here -->
      </section>

      <div class="pagination">
        <a href="#" class="prev" onclick="prevPage()">&laquo;</a>
        <a href="#" class="page-number active" onclick="changePage(1)">1</a>
        <a href="#" class="page-number" onclick="changePage(2)">2</a>
        <a href="#" class="page-number" onclick="changePage(3)">3</a>
        <a href="#" class="next" onclick="nextPage()">&raquo;</a>
      </div>
    </main>

    <script>
      // Function to handle Enter key press in search input
      function handleSearch(event) {
        if (event.key === "Enter") {
          searchBooksFromNav();
        }
      }

      // Function to execute book search from the navigation bar
      function searchBooksFromNav() {
        const query = document.getElementById("navSearchInput").value.trim();
        if (!query) {
          alert("Please enter a search query!");
          return;
        }
        window.location.href = `search-results.html?query=${encodeURIComponent(
          query
        )}`;
      }
      // Function to toggle the search popup visibility
      function toggleSearchPopup() {
        const popup = document.querySelector(".search-popup");
        popup.style.display =
          popup.style.display === "block" ? "none" : "block";
      }

      // Function to toggle the dropdown visibility
      function toggleDropdown() {
        const dropdown = document.querySelector(".dropdown");
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }

      // Function to handle language toggling
      function toggleLanguage() {
        alert("Language toggled!");
      }
      function logout() {
        console.log("ðŸ”´ Logging out...");

        // Clear session and local storage
        sessionStorage.clear();
        localStorage.clear();

        console.log("âœ… Storage cleared. Redirecting to login page...");

        // Redirect to login page
        window.location.href = "new_login.html";
      }

      const ownerId =
        sessionStorage.getItem("userId") || localStorage.getItem("userId");
      if (!ownerId) {
        alert("User not logged in! Redirecting to login...");
        window.location.href = "new_login.html";
      }
      let currentPage = 1;
      const booksPerPage = 15;
      let books = [];

      async function loadBooksOnLoan() {
        const userId =
          sessionStorage.getItem("userId") || localStorage.getItem("userId");

        if (!userId) {
          alert("User not logged in! Redirecting to login...");
          window.location.href = "new_login.html";
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:8080/books/owner/${userId}`
          );
          if (!response.ok) throw new Error("Failed to fetch books.");

          books = await response.json();
          displayBooks(currentPage);
        } catch (error) {
          console.error("Error loading books:", error);
        }
      }

      function displayBooks(page) {
        const bookContainer = document.getElementById("bookContainer");
        bookContainer.innerHTML = ""; // Clear previous books

        const startIndex = (page - 1) * booksPerPage;
        const endIndex = startIndex + booksPerPage;
        const booksToShow = books.slice(startIndex, endIndex);

        if (booksToShow.length === 0) {
          bookContainer.innerHTML = "<p>No books currently on loan.</p>";
          return;
        }

        booksToShow.forEach((book) => {
          const bookItem = document.createElement("div");
          bookItem.classList.add("book-item");
          bookItem.innerHTML = `
                <div class="book-placeholder">
                    <img src="${
                      book.image || "https://via.placeholder.com/150"
                    }" alt="${book.title}">
                </div>
                <p class="book-title">${book.title}</p>
            `;
          bookContainer.appendChild(bookItem);
        });

        updatePagination(page);
      }

      function updatePagination(page) {
        document.querySelectorAll(".page-number").forEach((el) => {
          el.classList.remove("active");
        });

        document
          .querySelector(`.pagination a:nth-child(${page + 1})`)
          .classList.add("active");

        currentPage = page;
      }

      function changePage(page) {
        if (page >= 1 && page <= Math.ceil(books.length / booksPerPage)) {
          displayBooks(page);
        }
      }

      function prevPage() {
        if (currentPage > 1) {
          changePage(currentPage - 1);
        }
      }

      function nextPage() {
        if (currentPage < Math.ceil(books.length / booksPerPage)) {
          changePage(currentPage + 1);
        }
      }

      document.addEventListener("DOMContentLoaded", loadBooksOnLoan);
    </script>
  </body>
</html>
